<html>
  <head>
    <link rel="stylesheet" href="//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">
  </head>

  <body>
    <h1>Tello Drone Controller</h1>
    <button class="button button-outline" id="connect">CONNECT</button>
    <button class="button button-outline" id="disconnect">DISCONNECT</button>
    <div class="container">
    <h2>command</h2>
      <form name="mycontroller">
        <button name="takeoff">TAKEOFF</button>
        <button name="land">LAND</button>
        <br><br>

        <button name="up">UP</button>
        <button name="down">DOWN</button>
        <br><br>

        <button name="forward">FORWARD</button>
        <button name="back">BACK</button>
        <button name="right">RIGHT</button>
        <button name="left">LEFT</button>  
      </form>

      <label>distance x [cm]</label>
      <input id="x" type="text" value="50">

      <form name="myform">
        <label>other command</label>
        <input name="text" type="text" placeholder="cw x(1-3600), ccw x(1-3600), flip x(l,r,f,b)">
        <button name="btn">SEND</button>
      </form>
   
      <hr>
      <label>Command Log</label>
      <ul id="log"></ul>
 
    </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
  <script>
    var uuid={};
        uuid["UART_SERVICE"]                 ='6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        uuid["UART_SERVICE_CHARACTERISTICS"] ='6e400002-b5a3-f393-e0a9-e50e24dcca9e';
    
    document.getElementById('connect').addEventListener('click', function(e) {
      e.preventDefault();
      connect();
    })
    document.getElementById('disconnect').addEventListener('click', function(e) {
      e.preventDefault();
      disconnect();
    })

    function connect(){
        navigator.bluetooth.requestDevice({
            filters: [{
                namePrefix: 'BBC micro:bit',
            }],
            optionalServices: [uuid["UART_SERVICE"]]
        })
        .then(device => {
            uart_device=device;
            console.log("device", device);
            return device.gatt.connect();
        })
        .then(server => {
            console.log("server", server)
            return server.getPrimaryService(uuid["UART_SERVICE"]);
        })
        .then(service => {
            console.log("service", service)
            return service.getCharacteristic(uuid["UART_SERVICE_CHARACTERISTICS"]);
        })
        .then(chara => {
            console.log("UART:", chara)
            alert("BLE connected");
            characteristic=chara;
            characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged',onCharacteristicValueChanged);
        })
        .catch(error => {
            alert("BLE error");
            console.log(error)
        });
    }

    function onCharacteristicValueChanged(e) {
        var str_arr=[];
        for(var i=0;i<this.value.byteLength;i++){
            str_arr[i]=this.value.getUint8(i);
        }
        var str=String.fromCharCode.apply(null,str_arr);
        // alert("msg:"+str);
        // socket.emit('chat', str);
        if(str=="up"){
            socket.emit('cmd', "up");
        }else if(str=="down"){
            socket.emit('cmd', "down");
        }else if(str=="right"){
            socket.emit('cmd', "right");
        }else if(str=="left"){
            socket.emit('cmd', "left");
        }
    }

    function disconnect() {
        if((!uart_device)||(!uart_device.gatt.connected)){
            return;
        }else{
            uart_device.gatt.disconnect();
            alert("BLE disconnected");
        }
    }


    // ##########################################
    // ##########################################
    // ##########################################
    var socket = io();
    var log = document.getElementById('log');
    var form = document.forms.myform;
    var controller = document.forms.mycontroller
    var x = document.getElementById("x");

    form.btn.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmdRaw', form.text.value);
      form.text.value = '';
    })

    x.addEventListener('change', function(e){
      e.preventDefault();
      socket.emit('x', x.value);
    })

    controller.takeoff.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "takeoff");
    })

    controller.land.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "land");
    })

    controller.up.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "up");
    })   

    controller.down.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "down");
    })

    controller.forward.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "forward");
    })

    controller.back.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "back");
    })

    controller.right.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "right");
    })

    controller.left.addEventListener('click', function(e) {
      e.preventDefault();
      socket.emit('cmd', "left");
    })

    

    socket.on('chat', function(msg){
      //ここに処理を記述する
      var li = document.createElement('li');
   
      li.textContent = msg;
      log.appendChild(li);
    });

  </script>
  </body>

</html>